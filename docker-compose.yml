version: '3.8'

services:
  forex-bot:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: forex-bot
    restart: unless-stopped
    ports:
      - '${PORT:-8080}:8080'
    environment:
      - NODE_ENV=production
      - PORT=8080
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://generativelanguage.googleapis.com/v1beta/openai/}
      - CHROME_DEBUG_URL=${CHROME_DEBUG_URL:-http://host.docker.internal:9222}
      - TIMEZONE=${TIMEZONE:-UTC}
    env_file:
      - .env
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:8080/ping',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Enable access to host network for Chrome DevTools Protocol
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Development service with hot reload
  forex-bot-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: forex-bot-dev
    profiles:
      - dev
    ports:
      - '${PORT:-8080}:8080'
    environment:
      - NODE_ENV=development
      - PORT=8080
    env_file:
      - .env
    volumes:
      - ./src:/app/src:ro
    command: yarn dev
    extra_hosts:
      - 'host.docker.internal:host-gateway'
